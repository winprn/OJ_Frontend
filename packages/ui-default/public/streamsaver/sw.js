self.addEventListener("install",()=>{self.skipWaiting()});self.addEventListener("activate",e=>{e.waitUntil(self.clients.claim())});const map=new Map;self.onmessage=e=>{if(e.data==="ping")return;const{data:t}=e,s=t.url||`${self.registration.scope+Math.random()}/${typeof t=="string"?t:t.filename}`,a=e.ports[0],n=new Array(3);n[1]=t,n[2]=a,e.data.readableStream?n[0]=e.data.readableStream:e.data.transferringReadable?a.onmessage=l=>{a.onmessage=null,n[0]=l.data.readableStream}:n[0]=createStream(a),map.set(s,n),a.postMessage({download:s})};function createStream(e){return new ReadableStream({start(t){e.onmessage=({data:s})=>{if(s==="end")return t.close();if(s==="abort"){t.error("Aborted the download");return}t.enqueue(s)}},cancel(){console.log("user aborted")}})}self.onfetch=e=>{const{url:t}=e.request;if(t.endsWith("/ping"))return e.respondWith(new Response("pong"));const s=map.get(t);if(!s)return null;const[a,n,l]=s;map.delete(t);const o=new Headers({"Content-Type":"application/octet-stream; charset=utf-8","Content-Security-Policy":"default-src 'none'","X-Content-Security-Policy":"default-src 'none'","X-WebKit-CSP":"default-src 'none'","X-XSS-Protection":"1; mode=block"}),r=new Headers(n.headers||{});r.has("Content-Length")&&o.set("Content-Length",r.get("Content-Length")),r.has("Content-Disposition")&&o.set("Content-Disposition",r.get("Content-Disposition")),n.size&&(console.warn("Depricated"),o.set("Content-Length",n.size));let i=typeof n=="string"?n:n.filename;i&&(console.warn("Depricated"),i=encodeURIComponent(i).replace(/['()]/g,escape).replace(/\*/g,"%2A"),o.set("Content-Disposition",`attachment; filename*=UTF-8''${i}`)),e.respondWith(new Response(a,{headers:o})),l.postMessage({debug:"Download started"})};
